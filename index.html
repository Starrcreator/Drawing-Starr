<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DrawSta - Performance Optimized</title>
    <style>
        * { 
            box-sizing: border-box; 
            -webkit-user-select: none; 
            user-select: none; 
            -webkit-touch-callout: none;
        }
        
        body { 
            margin: 0; background: #000; overflow: hidden; 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; 
            height: 100vh; width: 100vw; touch-action: none; 
        }
        
        #ui-panel { 
            position: absolute; top: 0; left: 0; z-index: 100; 
            background: rgba(25, 25, 25, 0.98); width: 175px; height: 100vh;
            padding: 12px 12px 50px 12px;
            border-right: 2px solid #444; color: white;
            display: flex; flex-direction: column; gap: 10px;
            overflow-y: auto;
            scrollbar-width: none;
        }
        #ui-panel::-webkit-scrollbar { display: none; }

        #show-menu-btn {
            position: absolute; top: 15px; left: 15px; z-index: 101;
            background: #007AFF; color: white; border: none; padding: 12px 16px;
            border-radius: 8px; font-size: 12px; font-weight: 700; display: none;
        }

        .dpad-wrapper { display: flex; justify-content: center; width: 100%; margin: 5px 0; }
        .dpad-container {
            display: grid; grid-template-columns: repeat(3, 1fr); grid-template-rows: repeat(3, 1fr);
            gap: 6px; width: 120px; height: 120px;
        }
        .nav-btn {
            background: #333; border: 1px solid #555; color: white;
            border-radius: 8px; font-size: 20px; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
        }
        .nav-btn:active { background: #007AFF; }
        .btn-up { grid-column: 2; grid-row: 1; }
        .btn-left { grid-column: 1; grid-row: 2; }
        .btn-right { grid-column: 3; grid-row: 2; }
        .btn-down { grid-column: 2; grid-row: 3; }

        #stage { 
            position: relative; width: 100vw; height: 100vh; overflow: hidden; 
            background: #000; display: flex; align-items: center; justify-content: center;
        }
        #square-box { position: absolute; transform-origin: center center; }
        #display-image { width: 100%; height: 100%; object-fit: contain; pointer-events: none; }
        #draw-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 5; touch-action: none; }

        #lock-shield { 
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; 
            z-index: 2000; display: none; background: transparent; touch-action: none;
        }
        #unlock-btn {
            position: fixed; top: 20px; right: 20px; z-index: 2001; width: 80px; height: 80px;
            background: rgba(0, 122, 255, 0.95); border: 4px solid #fff; border-radius: 50%;
            color: white; font-size: 11px; font-weight: 800; display: none; 
            align-items: center; justify-content: center; text-align: center;
            box-shadow: 0 0 20px rgba(0,0,0,0.7); touch-action: manipulation;
        }
        #unlock-btn span { pointer-events: none; }

        .section-title { font-size: 10px; color: #007AFF; font-weight: 800; text-transform: uppercase; border-bottom: 1px solid #333; padding-bottom: 2px; }
        .upload-lbl { display: block; padding: 12px; background: #1a1a1a; border: 2px dashed #007AFF; border-radius: 6px; color: #007AFF; text-align: center; font-size: 11px; font-weight: 700; }
        .tool-row { display: flex; gap: 5px; }
        .tool-btn { flex: 1; padding: 12px 5px; border-radius: 8px; background: #333; border: 1px solid #555; color: white; font-size: 18px; }
        .tool-btn.active { background: #007AFF; border-color: #fff; }
        .slider-container { margin: 5px 0; }
        .slider-label { font-size: 9px; color: #aaa; display: flex; justify-content: space-between; margin-bottom: 3px; }
        input[type="range"] { width: 100%; height: 8px; -webkit-appearance: none; background: #444; border-radius: 4px; outline: none; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; width: 18px; height: 18px; background: #007AFF; border-radius: 50%; border: 2px solid #fff; }
        .brush-btn { flex: 1; padding: 8px 2px; background: #333; border: 1px solid #555; border-radius: 4px; color: white; font-size: 10px; font-weight: bold; }
        .brush-btn.active { background: #007AFF; border-color: #fff; }
        .checkbox-label { color: white; display: flex; align-items: center; gap: 10px; font-size: 11px; margin: 2px 0; }
        
        .lock-trigger-btn {
            width: 100%; padding: 18px; background: #f39c12; color: white; border: none; 
            border-radius: 10px; font-weight: 800; font-size: 14px; margin-top: 10px;
            box-shadow: 0 4px 0 #d35400;
        }
        .lock-trigger-btn:active { transform: translateY(2px); box-shadow: 0 2px 0 #d35400; }
    </style>
</head>
<body>

    <button id="show-menu-btn" onclick="toggleMenu(true)">‚ò∞ MENU</button>

    <div id="ui-panel">
        <div style="text-align: center; font-size: 18px; font-weight: 800; color: #007AFF; margin-bottom: 5px;">DrawSta</div>

        <div class="section-title">1. Source</div>
        <label for="upload" class="upload-lbl">üì∏ OPEN IMAGE</label>
        <input type="file" id="upload" accept="image/*" style="display:none">
        
        <div class="section-title">2. Navigation</div>
        <div class="dpad-wrapper">
            <div class="dpad-container">
                <button class="nav-btn btn-up" onclick="moveView('up')">‚ñ≤</button>
                <button class="nav-btn btn-left" onclick="moveView('left')">‚óÄ</button>
                <button class="nav-btn btn-right" onclick="moveView('right')">‚ñ∂</button>
                <button class="nav-btn btn-down" onclick="moveView('down')">‚ñº</button>
            </div>
        </div>
        <button onclick="resetView()" style="width:100%; padding:8px; background:#333; color:#007AFF; border:1px solid #555; border-radius:6px; font-size:10px; font-weight:700;">‚Ü∫ RE-CENTER</button>

        <div class="section-title">3. Tools</div>
        <div class="tool-row">
            <button id="btn-move" class="tool-btn active" onclick="setTool('move')">ü§ö</button>
            <button id="btn-draw" class="tool-btn" onclick="setTool('draw')">‚úèÔ∏è</button>
            <button id="btn-erase" class="tool-btn" onclick="setTool('erase')">üßº</button>
        </div>
        <div class="tool-row">
            <button class="brush-btn" id="b-small" onclick="setBrushSize('small')">S</button>
            <button class="brush-btn active" id="b-med" onclick="setBrushSize('medium')">M</button>
            <button class="brush-btn" id="b-large" onclick="setBrushSize('large')">L</button>
        </div>
        <input type="color" id="penColor" value="#ff0000" style="width:100%; height:35px; border-radius:6px; border:2px solid #555; background:none;">

        <div class="section-title">4. Filters</div>
        <label class="checkbox-label"><input type="checkbox" id="colorToggle" checked onchange="updateView()"> Show Color</label>
        <label class="checkbox-label"><input type="checkbox" id="invToggle" onchange="updateView()"> Invert Image</label>

        <div class="slider-container">
            <div class="slider-label">Zoom <span id="zVal">1.0</span>x</div>
            <input type="range" id="zoomRange" min="0.05" max="10.0" step="0.01" value="1.0" oninput="updateView()">
        </div>
        <div class="slider-container">
            <div class="slider-label">Exposure <span id="brightVal">100</span>%</div>
            <input type="range" id="brightnessRange" min="20" max="250" value="100" oninput="updateView()">
        </div>
        <div class="slider-container">
            <div class="slider-label">Contrast <span id="contrastVal">100</span>%</div>
            <input type="range" id="contrastRange" min="50" max="300" value="100" oninput="updateView()">
        </div>

        <div class="section-title">5. Actions</div>
        <div class="tool-row">
            <button onclick="undo()" style="flex:1; padding:12px; background:#333; color:white; border:1px solid #555; border-radius:8px;">‚Ü∂</button>
            <button onclick="redo()" style="flex:1; padding:12px; background:#333; color:white; border:1px solid #555; border-radius:8px;">‚Ü∑</button>
        </div>

        <button class="lock-trigger-btn" onclick="lockApp()">üîí LOCK SCREEN</button>
    </div>

    <div id="lock-shield"></div>
    <div id="unlock-btn" ondblclick="unlockApp()"><span>DBL TAP<br>UNLOCK</span></div>

    <div id="stage">
        <div id="square-box">
            <img id="display-image">
            <canvas id="draw-canvas"></canvas>
        </div>
    </div>

    <script>
        const img = document.getElementById('display-image');
        const canvas = document.getElementById('draw-canvas');
        const ctx = canvas.getContext('2d');
        const box = document.getElementById('square-box');
        const ui = document.getElementById('ui-panel');
        const shield = document.getElementById('lock-shield');
        const unlockBtn = document.getElementById('unlock-btn');
        const zSlider = document.getElementById('zoomRange');
        
        let panX = 0, panY = 0, side = 0, isDragging = false, currentTool = 'move';
        let initialPinchDist = null, initialZoom = 1, startX, startY, wakeLock = null;
        let undoStack = [], redoStack = [];
        const brushSizes = { small: 6, medium: 12, large: 24 };
        let currentBrushSize = 'medium';

        document.getElementById('upload').onchange = (e) => {
            const reader = new FileReader();
            reader.onload = (f) => { 
                img.src = f.target.result; 
                img.onload = () => {
                    side = Math.max(img.naturalWidth, img.naturalHeight);
                    box.style.width = side + 'px'; box.style.height = side + 'px';
                    canvas.width = side; canvas.height = side;
                    resetView();
                };
            };
            reader.readAsDataURL(e.target.files[0]);
        };

        function moveView(dir) {
            const zoom = parseFloat(zSlider.value);
            const moveAmt = (Math.min(window.innerWidth, window.innerHeight) / zoom) * 0.8;
            if (dir === 'up') panY += moveAmt; if (dir === 'down') panY -= moveAmt;
            if (dir === 'left') panX += moveAmt; if (dir === 'right') panX -= moveAmt;
            updateView();
        }

        function updateView() {
            const zoom = parseFloat(zSlider.value);
            const bri = document.getElementById('brightnessRange').value;
            const con = document.getElementById('contrastRange').value;
            document.getElementById('zVal').innerText = zoom.toFixed(2);
            document.getElementById('brightVal').innerText = bri;
            document.getElementById('contrastVal').innerText = con;
            box.style.transform = `scale(${zoom}) translate(${panX}px, ${panY}px)`;
            const gray = document.getElementById('colorToggle').checked ? 0 : 100;
            const inv = document.getElementById('invToggle').checked ? 100 : 0;
            img.style.filter = `grayscale(${gray}%) invert(${inv}%) brightness(${bri}%) contrast(${con}%)`;
        }

        const handleTouch = (e) => {
            if (shield.style.display === 'block') return; 
            if (e.touches.length === 2) {
                const dist = Math.hypot(e.touches[0].pageX - e.touches[1].pageX, e.touches[0].pageY - e.touches[1].pageY);
                if (initialPinchDist === null) { initialPinchDist = dist; initialZoom = parseFloat(zSlider.value); }
                else { zSlider.value = (initialZoom * (dist / initialPinchDist)).toFixed(2); updateView(); }
                return;
            }
            const touch = e.touches[0];
            const rect = canvas.getBoundingClientRect();
            const scaleFac = side / rect.width;
            const x = (touch.clientX - rect.left) * scaleFac;
            const y = (touch.clientY - rect.top) * scaleFac;
            if (currentTool === 'move') {
                if (e.type === 'touchstart') { isDragging = true; startX = touch.clientX - (panX * parseFloat(zSlider.value)); startY = touch.clientY - (panY * parseFloat(zSlider.value)); }
                else if (e.type === 'touchmove' && isDragging) { panX = (touch.clientX - startX) / parseFloat(zSlider.value); panY = (touch.clientY - startY) / parseFloat(zSlider.value); updateView(); }
            } else {
                if (e.type === 'touchstart') { saveState(); ctx.beginPath(); ctx.moveTo(x, y); }
                else if (e.type === 'touchmove') {
                    ctx.globalCompositeOperation = (currentTool === 'erase') ? 'destination-out' : 'source-over';
                    ctx.lineTo(x, y); ctx.strokeStyle = document.getElementById('penColor').value;
                    ctx.lineWidth = (side / 1000) * brushSizes[currentBrushSize];
                    ctx.lineCap = "round"; ctx.stroke();
                }
            }
        };

        canvas.addEventListener('touchstart', handleTouch);
        canvas.addEventListener('touchmove', (e) => { e.preventDefault(); handleTouch(e); }, { passive: false });
        window.addEventListener('touchend', () => { isDragging = false; initialPinchDist = null; });

        async function lockApp() {
            ui.style.display = 'none'; 
            document.getElementById('show-menu-btn').style.display = 'none';
            shield.style.display = 'block'; 
            unlockBtn.style.display = 'flex';
            try { if ('wakeLock' in navigator) wakeLock = await navigator.wakeLock.request('screen'); } catch (err) {}
        }

        function unlockApp() {
            ui.style.display = 'flex'; 
            shield.style.display = 'none'; 
            unlockBtn.style.display = 'none';
            if (wakeLock) { wakeLock.release(); wakeLock = null; }
        }

        function setTool(t) { currentTool = t; document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active')); document.getElementById('btn-'+t).classList.add('active'); }
        function setBrushSize(s) { currentBrushSize = s; document.querySelectorAll('.brush-btn').forEach(b => b.classList.remove('active')); document.getElementById('b-' + (s === 'medium' ? 'med' : s)).classList.add('active'); }
        function toggleMenu(v) { ui.style.display = v ? 'flex' : 'none'; document.getElementById('show-menu-btn').style.display = v ? 'none' : 'block'; }
        function resetView() { panX = 0; panY = 0; zSlider.value = 1.0; updateView(); }
        function saveState() { undoStack.push(ctx.getImageData(0, 0, side, side)); if (undoStack.length > 30) undoStack.shift(); redoStack = []; }
        function undo() { if (undoStack.length > 0) { redoStack.push(ctx.getImageData(0, 0, side, side)); ctx.putImageData(undoStack.pop(), 0, 0); } }
        function redo() { if (redoStack.length > 0) { undoStack.push(ctx.getImageData(0, 0, side, side)); ctx.putImageData(redoStack.pop(), 0, 0); } }
    </script>
</body>
</html>
