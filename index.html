<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Drawing-Starr</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#000000">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">

    <style>
        body { 
            margin: 0; background: #000; overflow: hidden; font-family: sans-serif; 
            height: 100vh; width: 100vw; touch-action: none; 
            -webkit-user-select: none; user-select: none;
        }
        
        #ui-panel { 
            position: absolute; top: 10px; left: 10px; z-index: 100; 
            background: rgba(20, 20, 20, 0.85); backdrop-filter: blur(8px);
            padding: 10px; border-radius: 12px; color: white; 
            width: 190px; border: 1px solid rgba(255, 255, 255, 0.1); 
            pointer-events: auto; max-height: 90vh; overflow-y: auto; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }

        #show-menu-btn {
            position: absolute; top: 15px; left: 15px; z-index: 101;
            background: rgba(0, 122, 255, 0.8); color: white; border: none;
            padding: 8px 12px; border-radius: 20px; font-size: 10px; font-weight: bold;
            display: none; cursor: pointer;
        }

        #upload { display: none; }
        .custom-file-upload {
            display: block; width: 100%; padding: 8px; margin-top: 4px;
            background: rgba(28, 28, 30, 0.6); border: 1.5px dashed #007AFF; border-radius: 6px;
            color: #007AFF; text-align: center; font-weight: bold; font-size: 8px;
            cursor: pointer; box-sizing: border-box;
        }

        #stage { 
            position: relative; width: 100vw; height: 100vh; overflow: hidden; z-index: 1; 
            display: flex; justify-content: center; align-items: center; background: #000;
        }

        #content-wrapper { 
            position: absolute; top: 50%; left: 50%; display: none; 
            transform-origin: center center; will-change: transform; 
        }

        #display-image { width: 100%; height: 100%; display: block; pointer-events: none; }
        
        #draw-canvas { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            z-index: 5; touch-action: none;
        }
        
        label { display: block; margin-top: 6px; font-size: 8px; color: #007AFF; font-weight: bold; text-transform: uppercase; }
        select, input[type="range"] { width: 100%; margin-top: 2px; height: 20px; background: transparent; color: white; }
        
        .btn-row { display: flex; gap: 4px; margin-top: 6px; }
        .check-row { display: flex; align-items: center; gap: 5px; margin-top: 4px; font-size: 9px; }
        
        button { flex: 1; padding: 6px; border: none; border-radius: 5px; font-weight: bold; font-size: 8px; cursor: pointer; }
        .blue-btn { background: #007AFF; color: white; width: 100%; margin-top: 6px; padding: 10px; font-size: 10px; }
        .gray-btn { background: rgba(68, 68, 68, 0.7); color: white; }
        .red-btn { background: #D32F2F; color: white; }
        .save-btn { background: #2E7D32; color: white; margin-top: 5px; width: 100%; }

        #unlock-btn {
            position: fixed; top: 20px; right: 20px; z-index: 200;
            width: 55px; height: 55px; background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255,255,255,0.4); border-radius: 50%;
            color: white; font-size: 8px; display: none; align-items: center; justify-content: center; 
            text-align: center; backdrop-filter: blur(8px);
        }
        #lock-shield { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 150; display: none; }
        
        #gallery { margin-top: 10px; border-top: 1px solid #444; padding-top: 5px; }
        #gallery-list { display: flex; gap: 5px; overflow-x: auto; padding: 5px 0; }
        .gallery-item { 
            min-width: 50px; height: 50px; border: 1px solid #555; border-radius: 4px; 
            background-size: cover; background-position: center; flex-shrink: 0;
        }
    </style>
</head>
<body>

    <button id="show-menu-btn" onclick="toggleMenu(true)">SHOW MENU</button>

    <div id="ui-panel">
        <label>1. Drawing-Starr Setup</label>
        <label for="upload" class="custom-file-upload">+ CHOOSE IMAGE</label>
        <input type="file" id="upload" accept="image/*">
        
        <label>2. Interaction Mode</label>
        <select id="touchMode" onchange="updateView()">
            <option value="move">ü§ö MOVE / ZOOM</option>
            <option value="draw">‚úèÔ∏è HIGHLIGHT LINES</option>
        </select>

        <label>Zoom (<span id="zoomVal">1.0</span>x)</label>
        <input type="range" id="zoomRange" min="1.0" max="6.0" step="0.1" value="1.0">

        <label>3. Visual Filters</label>
        <div class="check-row">
            <input type="checkbox" id="invertToggle" onchange="updateView()">
            <span>INVERT (NEGATIVE)</span>
        </div>
        <div class="btn-row">
            <button class="gray-btn" onclick="rotateImg()">ROTATE</button>
            <button class="red-btn" onclick="clearDraw()">CLEAR DRAW</button>
        </div>

        <label>4. Line Definition</label>
        <input type="range" id="contrast" min="100" max="800" value="300" oninput="updateView()">
        
        <button class="save-btn" onclick="saveProject()">üíæ SAVE PROJECT</button>
        <button class="blue-btn" onclick="lockApp()">LOCK & START</button>

        <div id="gallery">
            <label>SAVED PROJECTS</label>
            <div id="gallery-list"></div>
        </div>
    </div>

    <div id="unlock-btn" ondblclick="unlockApp()">DBL TAP<br>UNLOCK</div>
    <div id="lock-shield"></div>

    <div id="stage">
        <div id="content-wrapper">
            <img id="display-image" draggable="false">
            <canvas id="draw-canvas"></canvas>
        </div>
    </div>

    <script>
        const img = document.getElementById('display-image');
        const canvas = document.getElementById('draw-canvas');
        const ctx = canvas.getContext('2d');
        const wrapper = document.getElementById('content-wrapper');
        const ui = document.getElementById('ui-panel');
        const showBtn = document.getElementById('show-menu-btn');
        const shield = document.getElementById('lock-shield');
        const unlockBtn = document.getElementById('unlock-btn');
        
        let panX = 0, panY = 0, startX = 0, startY = 0, isDragging = false;
        let rotation = 0, currentImgData = null, wakeLock = null;

        // DB Setup for Saving
        let db;
        const dbReq = indexedDB.open("DrawStaDB", 1);
        dbReq.onupgradeneeded = (e) => {
            db = e.target.result;
            db.createObjectStore("projects", { keyPath: "id", autoIncrement: true });
        };
        dbReq.onsuccess = (e) => { db = e.target.result; loadGallery(); };

        async function requestWakeLock() {
            try {
                if ('wakeLock' in navigator) wakeLock = await navigator.wakeLock.request('screen');
            } catch (err) { console.error(err); }
        }

        document.getElementById('upload').onchange = (e) => {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = (ev) => {
                currentImgData = ev.target.result;
                img.src = currentImgData;
                wrapper.style.display = 'block';
                img.onload = () => {
                    canvas.width = img.naturalWidth;
                    canvas.height = img.naturalHeight;
                    resetAll();
                };
            };
            reader.readAsDataURL(file);
        };

        function updateView() {
            if (!img.src) return;
            const zoom = parseFloat(document.getElementById('zoomRange').value);
            document.getElementById('zoomVal').innerText = zoom.toFixed(1);
            
            wrapper.style.width = (zoom * 100) + "vw";
            wrapper.style.transform = `translate(-50%, -50%) translate(${panX}px, ${panY}px) rotate(${rotation}deg)`;
            
            const inv = document.getElementById('invertToggle').checked ? "invert(100%)" : "invert(0%)";
            const con = document.getElementById('contrast').value;
            img.style.filter = `grayscale(100%) ${inv} contrast(${con}%)`;
            canvas.style.filter = document.getElementById('invertToggle').checked ? "invert(100%)" : "none";
        }

        function saveProject() {
            if (!currentImgData) return;
            const transaction = db.transaction(["projects"], "readwrite");
            const project = {
                image: currentImgData,
                drawing: canvas.toDataURL(),
                timestamp: Date.now()
            };
            transaction.objectStore("projects").add(project);
            transaction.oncomplete = () => { alert("Project Saved!"); loadGallery(); };
        }

        function loadGallery() {
            const list = document.getElementById('gallery-list');
            list.innerHTML = "";
            db.transaction("projects").objectStore("projects").openCursor(null, "prev").onsuccess = (e) => {
                const cursor = e.target.result;
                if (cursor) {
                    const item = document.createElement('div');
                    item.className = "gallery-item";
                    item.style.backgroundImage = `url(${cursor.value.image})`;
                    item.onclick = () => {
                        currentImgData = cursor.value.image;
                        img.src = cursor.value.image;
                        wrapper.style.display = 'block';
                        img.onload = () => {
                            canvas.width = img.naturalWidth;
                            canvas.height = img.naturalHeight;
                            const overlay = new Image();
                            overlay.onload = () => ctx.drawImage(overlay, 0, 0);
                            overlay.src = cursor.value.drawing;
                            updateView();
                        };
                    };
                    list.appendChild(item);
                    cursor.continue();
                }
            };
        }

        const handleTouch = (e) => {
            if (shield.style.display === 'block') return;
            const mode = document.getElementById('touchMode').value;
            const touch = e.touches[0];
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            const x = (touch.clientX - rect.left) * scaleX;
            const y = (touch.clientY - rect.top) * scaleY;

            if (mode === 'draw') {
                if (e.type === 'touchstart') { ctx.beginPath(); ctx.moveTo(x, y); }
                else if (e.type === 'touchmove') { 
                    ctx.lineTo(x, y); ctx.strokeStyle = "#007AFF"; ctx.lineWidth = 4; ctx.lineCap = "round"; ctx.stroke(); 
                }
            } else {
                if (e.type === 'touchstart') { isDragging = true; startX = touch.clientX - panX; startY = touch.clientY - panY; }
                else if (e.type === 'touchmove' && isDragging) { panX = touch.clientX - startX; panY = touch.clientY - startY; updateView(); }
            }
        };

        canvas.addEventListener('touchstart', handleTouch);
        canvas.addEventListener('touchmove', (e) => { e.preventDefault(); handleTouch(e); }, { passive: false });
        window.addEventListener('touchend', () => isDragging = false);

        function clearDraw() { ctx.clearRect(0, 0, canvas.width, canvas.height); }
        function rotateImg() { rotation = (rotation + 90) % 360; updateView(); }
        function resetAll() { panX = 0; panY = 0; rotation = 0; document.getElementById('zoomRange').value = 1.0; updateView(); }
        function toggleMenu(v) { ui.style.display = v ? 'block' : 'none'; showBtn.style.display = v ? 'none' : 'block'; }

        function lockApp() {
            if (!img.src) return;
            toggleMenu(false); shield.style.display = 'block'; unlockBtn.style.display = 'flex';
            requestWakeLock();
            if (document.documentElement.requestFullscreen) document.documentElement.requestFullscreen();
        }

        function unlockApp() {
            toggleMenu(true); shield.style.display = 'none'; unlockBtn.style.display = 'none';
            if (wakeLock) { wakeLock.release(); wakeLock = null; }
            if (document.exitFullscreen) document.exitFullscreen();
        }
    </script>
</body>
</html>
