<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Drawing Starr - Precision Tracing</title>
    <style>
        * { box-sizing: border-box; }
        body { 
            margin: 0; background: #000; overflow: hidden; 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; 
            height: 100vh; width: 100vw; touch-action: none; 
        }
        
        #ui-panel { 
            position: absolute; top: 0; left: 0; z-index: 100; 
            background: rgba(20, 20, 20, 0.98); width: 160px; height: 100vh;
            padding: 12px; border-right: 2px solid #444; color: white;
            display: flex; flex-direction: column; gap: 8px;
            overflow-y: auto;
        }

        #show-menu-btn {
            position: absolute; top: 10px; left: 10px; z-index: 101;
            background: #007AFF; color: white; border: none; padding: 10px 14px;
            border-radius: 8px; font-size: 11px; font-weight: 600; display: none;
        }

        .section-title { font-size: 9px; color: #007AFF; font-weight: 700; text-transform: uppercase; margin-top: 6px; }

        .upload-lbl {
            display: block; padding: 10px; background: #1a1a1a; border: 2px dashed #007AFF;
            border-radius: 6px; color: #007AFF; text-align: center; font-size: 10px; font-weight: 600;
        }

        /* D-PAD */
        .dpad-container {
            display: grid; grid-template-areas: ". up ." "left . right" ". down .";
            gap: 4px; width: 100%; aspect-ratio: 1/1; margin-bottom: 5px;
        }
        .nav-btn {
            background: #2a2a2a; border: 2px solid #444; color: white;
            border-radius: 6px; font-size: 18px; cursor: pointer; display: flex;
            align-items: center; justify-content: center; height: 40px;
        }
        .nav-btn:active { background: #007AFF; }

        #stage { 
            position: relative; width: 100vw; height: 100vh; overflow: hidden; 
            background: #000; display: flex; align-items: center; justify-content: center;
        }
        #square-box { position: absolute; transform-origin: center center; }
        #display-image { width: 100%; height: 100%; object-fit: contain; pointer-events: none; }
        #draw-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 5; touch-action: none; }

        .tool-row { display: flex; gap: 5px; }
        .tool-btn { flex: 1; padding: 10px 5px; border-radius: 6px; background: #2a2a2a; border: 2px solid #444; color: white; font-size: 16px; }
        .tool-btn.active { background: #007AFF; border-color: #007AFF; }
        
        .slider-container { margin: 4px 0; }
        .slider-label { font-size: 8px; color: #888; display: flex; justify-content: space-between; }
        .slider-value { color: #007AFF; font-weight: 600; }
        input[type="range"] { width: 100%; height: 6px; -webkit-appearance: none; background: #444; border-radius: 3px; outline: none; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; width: 16px; height: 16px; background: #007AFF; border-radius: 50%; }

        .brush-btn { flex: 1; padding: 6px 2px; background: #2a2a2a; border: 2px solid #444; border-radius: 4px; color: white; font-size: 9px; }
        .brush-btn.active { background: #007AFF; }
        
        .checkbox-group { display: flex; flex-direction: column; gap: 4px; margin: 4px 0; }
        .checkbox-label { color: white; display: flex; align-items: center; gap: 8px; font-size: 10px; }

        input[type="color"] { width: 100%; height: 30px; border: 2px solid #444; background: none; border-radius: 6px; }

        #unlock-btn {
            position: fixed; top: 15px; right: 15px; z-index: 200; width: 70px; height: 70px;
            background: rgba(0, 122, 255, 0.9); border: 3px solid #fff; border-radius: 50%;
            color: white; font-size: 9px; font-weight: 700; display: none; align-items: center; justify-content: center; text-align: center;
        }
        #lock-shield { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 150; display: none; }
    </style>
</head>
<body>

    <button id="show-menu-btn" onclick="toggleMenu(true)">‚ò∞ MENU</button>

    <div id="ui-panel">
        <div style="text-align: center; font-size: 16px; font-weight: 700; color: #007AFF;">DrawSta</div>

        <div class="section-title">1. Image</div>
        <label for="upload" class="upload-lbl">üì∏ SELECT</label>
        <input type="file" id="upload" accept="image/*" style="display:none">
        
        <div class="section-title">2. Navigate</div>
        <div class="dpad-container">
            <button class="nav-btn" style="grid-area: up" onclick="moveView('up')">‚ñ≤</button>
            <button class="nav-btn" style="grid-area: left" onclick="moveView('left')">‚óÄ</button>
            <button class="nav-btn" style="grid-area: right" onclick="moveView('right')">‚ñ∂</button>
            <button class="nav-btn" style="grid-area: down" onclick="moveView('down')">‚ñº</button>
        </div>
        <button onclick="resetView()" style="width:100%; padding:8px; background:#2a2a2a; border:1px solid #444; color:#007AFF; border-radius:6px; font-size:10px;">‚Ü∫ RE-CENTER</button>

        <div class="section-title">3. Tools</div>
        <div class="tool-row">
            <button id="btn-move" class="tool-btn active" onclick="setTool('move')">ü§ö</button>
            <button id="btn-draw" class="tool-btn" onclick="setTool('draw')">‚úèÔ∏è</button>
            <button id="btn-erase" class="tool-btn" onclick="setTool('erase')">üßº</button>
        </div>

        <div class="tool-row">
            <button class="brush-btn" id="b-small" onclick="setBrushSize('small')">S</button>
            <button class="brush-btn active" id="b-med" onclick="setBrushSize('medium')">M</button>
            <button class="brush-btn" id="b-large" onclick="setBrushSize('large')">L</button>
        </div>

        <input type="color" id="penColor" value="#ff0000">

        <div class="section-title">4. Filters</div>
        <div class="checkbox-group">
            <label class="checkbox-label"><input type="checkbox" id="colorToggle" checked onchange="updateView()"> Color</label>
            <label class="checkbox-label"><input type="checkbox" id="invToggle" onchange="updateView()"> Invert</label>
        </div>

        <div class="slider-container">
            <div class="slider-label">Zoom <span class="slider-value"><span id="zVal">1.0</span>x</span></div>
            <input type="range" id="zoomRange" min="0.05" max="10.0" step="0.01" value="1.0" oninput="updateView()">
        </div>

        <div class="slider-container">
            <div class="slider-label">Brightness <span class="slider-value"><span id="brightVal">100</span>%</span></div>
            <input type="range" id="brightnessRange" min="20" max="250" step="1" value="100" oninput="updateView()">
        </div>

        <div class="slider-container">
            <div class="slider-label">Contrast <span class="slider-value"><span id="contrastVal">100</span>%</span></div>
            <input type="range" id="contrastRange" min="50" max="300" step="1" value="100" oninput="updateView()">
        </div>

        <div class="tool-row">
            <button onclick="undo()" style="flex:1; padding:8px; background:#2a2a2a; color:white; border:1px solid #444; border-radius:4px;">‚Ü∂</button>
            <button onclick="redo()" style="flex:1; padding:8px; background:#2a2a2a; color:white; border:1px solid #444; border-radius:4px;">‚Ü∑</button>
        </div>

        <button onclick="saveDrawing()" style="width:100%; padding:10px; background:#007AFF; color:white; border:none; border-radius:6px; font-weight:700; margin-top:5px;">üíæ SAVE</button>
        <button onclick="lockApp()" style="width:100%; padding:10px; background:#444; color:white; border:none; border-radius:6px; font-weight:700; margin-top:5px;">üîí LOCK</button>
    </div>

    <div id="unlock-btn" ondblclick="unlockApp()">DBL TAP<br>UNLOCK</div>
    <div id="lock-shield"></div>

    <div id="stage">
        <div id="square-box">
            <img id="display-image">
            <canvas id="draw-canvas"></canvas>
        </div>
    </div>

    <script>
        const img = document.getElementById('display-image');
        const canvas = document.getElementById('draw-canvas');
        const ctx = canvas.getContext('2d');
        const box = document.getElementById('square-box');
        const ui = document.getElementById('ui-panel');
        const showBtn = document.getElementById('show-menu-btn');
        const shield = document.getElementById('lock-shield');
        const unlockBtn = document.getElementById('unlock-btn');
        const zSlider = document.getElementById('zoomRange');
        const bSlider = document.getElementById('brightnessRange');
        const cSlider = document.getElementById('contrastRange');
        
        let panX = 0, panY = 0, side = 0;
        let startX, startY, isDragging = false, currentTool = 'move';
        let initialPinchDist = null, initialZoom = 1;
        let wakeLock = null;
        let undoStack = [];
        let redoStack = [];
        const brushSizes = { small: 6, medium: 12, large: 24 };
        let currentBrushSize = 'medium';

        document.getElementById('upload').onchange = (e) => {
            const reader = new FileReader();
            reader.onload = (f) => { 
                img.src = f.target.result; 
                img.onload = () => {
                    side = Math.max(img.naturalWidth, img.naturalHeight);
                    box.style.width = side + 'px'; 
                    box.style.height = side + 'px';
                    canvas.width = side; canvas.height = side;
                    resetView();
                };
            };
            reader.readAsDataURL(e.target.files[0]);
        };

        function moveView(dir) {
            const zoom = parseFloat(zSlider.value);
            const moveAmt = (Math.min(window.innerWidth, window.innerHeight) / zoom) * 0.8;
            if (dir === 'up') panY += moveAmt;
            if (dir === 'down') panY -= moveAmt;
            if (dir === 'left') panX += moveAmt;
            if (dir === 'right') panX -= moveAmt;
            updateView();
        }

        function updateView() {
            const zoom = parseFloat(zSlider.value);
            const brightness = bSlider.value;
            const contrast = cSlider.value;
            
            document.getElementById('zVal').innerText = zoom.toFixed(2);
            document.getElementById('brightVal').innerText = brightness;
            document.getElementById('contrastVal').innerText = contrast;
            
            box.style.transform = `scale(${zoom}) translate(${panX}px, ${panY}px)`;
            
            const gray = document.getElementById('colorToggle').checked ? 0 : 100;
            const inv = document.getElementById('invToggle').checked ? 100 : 0;
            img.style.filter = `grayscale(${gray}%) invert(${inv}%) brightness(${brightness}%) contrast(${contrast}%)`;
        }

        const handleTouch = (e) => {
            if (shield.style.display === 'block') return;
            
            if (e.touches.length === 2) {
                const dist = Math.hypot(e.touches[0].pageX - e.touches[1].pageX, e.touches[0].pageY - e.touches[1].pageY);
                if (initialPinchDist === null) {
                    initialPinchDist = dist;
                    initialZoom = parseFloat(zSlider.value);
                } else {
                    const factor = dist / initialPinchDist;
                    zSlider.value = (initialZoom * factor).toFixed(2);
                    updateView();
                }
                return;
            }

            const touch = e.touches[0];
            const rect = canvas.getBoundingClientRect();
            const scaleFac = side / rect.width;
            const x = (touch.clientX - rect.left) * scaleFac;
            const y = (touch.clientY - rect.top) * scaleFac;

            if (currentTool === 'move') {
                if (e.type === 'touchstart') { 
                    isDragging = true; 
                    startX = touch.clientX - (panX * parseFloat(zSlider.value)); 
                    startY = touch.clientY - (panY * parseFloat(zSlider.value)); 
                }
                else if (e.type === 'touchmove' && isDragging) { 
                    panX = (touch.clientX - startX) / parseFloat(zSlider.value); 
                    panY = (touch.clientY - startY) / parseFloat(zSlider.value); 
                    updateView(); 
                }
            } else {
                if (e.type === 'touchstart') { 
                    saveState(); 
                    ctx.beginPath(); 
                    ctx.moveTo(x, y); 
                }
                else if (e.type === 'touchmove') {
                    ctx.globalCompositeOperation = (currentTool === 'erase') ? 'destination-out' : 'source-over';
                    ctx.lineTo(x, y);
                    ctx.strokeStyle = document.getElementById('penColor').value;
                    ctx.lineWidth = (side / 1000) * brushSizes[currentBrushSize];
                    ctx.lineCap = "round"; 
                    ctx.stroke();
                }
            }
        };

        canvas.addEventListener('touchstart', handleTouch);
        canvas.addEventListener('touchmove', (e) => { e.preventDefault(); handleTouch(e); }, { passive: false });
        window.addEventListener('touchend', () => { isDragging = false; initialPinchDist = null; });

        function setTool(t) { 
            currentTool = t; 
            document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('btn-'+t).classList.add('active');
        }

        function setBrushSize(s) {
            currentBrushSize = s;
            document.querySelectorAll('.brush-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('b-' + (s === 'medium' ? 'med' : s)).classList.add('active');
        }

        async function lockApp() {
            toggleMenu(false); shield.style.display = 'block'; unlockBtn.style.display = 'flex';
            try { if ('wakeLock' in navigator) wakeLock = await navigator.wakeLock.request('screen'); } catch (err) {}
        }

        function unlockApp() {
            toggleMenu(true); shield.style.display = 'none'; unlockBtn.style.display = 'none';
            if (wakeLock) { wakeLock.release(); wakeLock = null; }
        }

        function toggleMenu(v) { ui.style.display = v ? 'flex' : 'none'; showBtn.style.display = v ? 'none' : 'block'; }
        function resetView() { panX = 0; panY = 0; zSlider.value = 1.0; updateView(); }
        
        function saveState() { 
            undoStack.push(ctx.getImageData(0, 0, side, side)); 
            if (undoStack.length > 30) undoStack.shift(); 
            redoStack = []; 
        }
        
        function undo() { 
            if (undoStack.length > 0) {
                redoStack.push(ctx.getImageData(0, 0, side, side));
                ctx.putImageData(undoStack.pop(), 0, 0); 
            }
        }

        function redo() {
            if (redoStack.length > 0) {
                undoStack.push(ctx.getImageData(0, 0, side, side));
                ctx.putImageData(redoStack.pop(), 0, 0);
            }
        }

        function saveDrawing() {
            const temp = document.createElement('canvas'); temp.width = side; temp.height = side;
            const tCtx = temp.getContext('2d'); tCtx.drawImage(img, 0, 0, side, side); tCtx.drawImage(canvas, 0, 0);
            const link = document.createElement('a'); link.download = 'DrawSta.png'; link.href = temp.toDataURL(); link.click();
        }
    </script>
</body>
</html>
