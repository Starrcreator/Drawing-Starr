<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Drawing-Starr</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#000000">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">

    <style>
        body { 
            margin: 0; background: #000; overflow: hidden; font-family: sans-serif; 
            height: 100vh; width: 100vw; touch-action: none; 
            -webkit-user-select: none; user-select: none;
        }
        
        #ui-panel { 
            position: absolute; top: 10px; left: 10px; z-index: 100; 
            background: rgba(20, 20, 20, 0.85); backdrop-filter: blur(8px);
            padding: 8px; border-radius: 10px; color: white; 
            width: 170px; border: 1px solid rgba(255, 255, 255, 0.1); 
            pointer-events: auto; max-height: 90vh; overflow-y: auto; 
        }

        #show-menu-btn {
            position: absolute; top: 15px; left: 15px; z-index: 101;
            background: rgba(0, 122, 255, 0.8); color: white; border: none;
            padding: 8px 12px; border-radius: 20px; font-size: 10px; font-weight: bold;
            display: none; cursor: pointer;
        }

        #upload { display: none; }
        .custom-file-upload {
            display: block; width: 100%; padding: 8px; margin-top: 4px;
            background: rgba(28, 28, 30, 0.6); border: 1.5px dashed #007AFF; border-radius: 6px;
            color: #007AFF; text-align: center; font-weight: bold; font-size: 8px;
        }

        .grid-container {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 2px;
            margin: 8px auto; width: 80px; aspect-ratio: 1 / 1;
        }
        .grid-btn {
            background: rgba(51, 51, 51, 0.5); border: 1px solid #555; border-radius: 3px; 
            height: 24px; cursor: pointer;
        }
        .grid-btn.active { background: #007AFF; border-color: #007AFF; }

        #stage { 
            position: relative; width: 100vw; height: 100vh; overflow: hidden; 
            background: #000; display: flex; align-items: center; justify-content: center;
        }

        #content-wrapper { 
            position: absolute; width: 100%; height: 100%;
            display: none; will-change: transform;
        }
        #display-image { position: absolute; width: 100%; height: 100%; object-fit: contain; pointer-events: none; }
        #draw-canvas { position: absolute; width: 100%; height: 100%; z-index: 5; touch-action: none; }
        
        label { display: block; margin-top: 6px; font-size: 8px; color: #007AFF; font-weight: bold; text-transform: uppercase; }
        input[type="range"], select { width: 100%; margin-top: 2px; height: 15px; background: #222; color: white; border: none; font-size: 9px; }
        .check-row { display: flex; align-items: center; gap: 5px; margin-top: 6px; font-size: 9px; }
        
        button { flex: 1; padding: 6px; border: none; border-radius: 5px; font-weight: bold; font-size: 8px; }
        .blue-btn { background: #007AFF; color: white; width: 100%; margin-top: 6px; padding: 10px; font-size: 10px; }
        .gray-btn { background: rgba(68, 68, 68, 0.7); color: white; }
        .red-btn { background: #D32F2F; color: white; }
        .save-btn { background: #2E7D32; color: white; margin-top: 5px; width: 100%; }

        #unlock-btn {
            position: fixed; top: 20px; right: 20px; z-index: 200;
            width: 55px; height: 55px; background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255,255,255,0.4); border-radius: 50%;
            color: white; font-size: 8px; display: none; align-items: center; justify-content: center; 
            text-align: center; backdrop-filter: blur(8px);
        }
        #lock-shield { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 150; display: none; }
        
        #gallery-list { display: flex; gap: 4px; overflow-x: auto; padding: 4px 0; margin-top: 5px; border-top: 1px solid #444; }
        .gallery-item { min-width: 40px; height: 40px; border: 1px solid #555; border-radius: 3px; background-size: cover; flex-shrink: 0; }
    </style>
</head>
<body>

    <button id="show-menu-btn" onclick="toggleMenu(true)">SHOW MENU</button>

    <div id="ui-panel">
        <label>1. Drawing-Starr</label>
        <label for="upload" class="custom-file-upload">+ IMAGE</label>
        <input type="file" id="upload" accept="image/*">
        
        <label>2. Focus Grid (10% Overlap)</label>
        <div class="grid-container">
            <button class="grid-btn" onclick="setGrid(0, 0, 0)"></button>
            <button class="grid-btn" onclick="setGrid(-45, 0, 1)"></button>
            <button class="grid-btn" onclick="setGrid(-90, 0, 2)"></button>
            <button class="grid-btn" onclick="setGrid(0, -45, 3)"></button>
            <button class="grid-btn" onclick="setGrid(-45, -45, 4)"></button>
            <button class="grid-btn" onclick="setGrid(-90, -45, 5)"></button>
            <button class="grid-btn" onclick="setGrid(0, -90, 6)"></button>
            <button class="grid-btn" onclick="setGrid(-45, -90, 7)"></button>
            <button class="grid-btn" onclick="setGrid(-90, -90, 8)"></button>
        </div>

        <select id="touchMode">
            <option value="move">ü§ö MOVE/ZOOM</option>
            <option value="draw">‚úèÔ∏è HIGHLIGHT</option>
        </select>
        <input type="range" id="zoomRange" min="1.0" max="6.0" step="0.1" value="1.0" oninput="updateView()">

        <label>3. View Options</label>
        <div class="check-row">
            <input type="checkbox" id="colorToggle" onchange="updateView()"> <span>COLOR</span>
            <input type="checkbox" id="invertToggle" onchange="updateView()"> <span>INVERT</span>
        </div>
        
        <div style="display:flex; gap:4px; margin-top:6px;">
            <button class="gray-btn" onclick="rotateImg()">ROTATE</button>
            <button class="red-btn" onclick="clearDraw()">CLEAR</button>
        </div>

        <label>4. Line Contrast</label>
        <input type="range" id="contrast" min="100" max="800" value="300" oninput="updateView()">
        
        <button class="save-btn" onclick="saveProject()">üíæ SAVE PROJECT</button>
        <button class="blue-btn" onclick="lockApp()">LOCK & START</button>

        <div id="gallery-list"></div>
    </div>

    <div id="unlock-btn" ondblclick="unlockApp()">DBL TAP<br>UNLOCK</div>
    <div id="lock-shield"></div>

    <div id="stage">
        <div id="content-wrapper">
            <img id="display-image" draggable="false">
            <canvas id="draw-canvas"></canvas>
        </div>
    </div>

    <script>
        const img = document.getElementById('display-image');
        const canvas = document.getElementById('draw-canvas');
        const ctx = canvas.getContext('2d');
        const wrapper = document.getElementById('content-wrapper');
        const ui = document.getElementById('ui-panel');
        const showBtn = document.getElementById('show-menu-btn');
        const shield = document.getElementById('lock-shield');
        const unlockBtn = document.getElementById('unlock-btn');
        const zoomRange = document.getElementById('zoomRange');
        
        let panX = 0, panY = 0, gridOffsetX = 0, gridOffsetY = 0;
        let startX = 0, startY = 0, isDragging = false, rotation = 0, flip = 1, wakeLock = null;

        // DB Setup
        let db;
        const dbReq = indexedDB.open("DrawStaDB_v2", 1);
        dbReq.onupgradeneeded = (e) => { e.target.result.createObjectStore("projects", { keyPath: "id", autoIncrement: true }); };
        dbReq.onsuccess = (e) => { db = e.target.result; loadGallery(); };

        document.getElementById('upload').onchange = (e) => {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = (ev) => {
                img.src = ev.target.result;
                wrapper.style.display = 'block';
                img.onload = () => {
                    canvas.width = img.naturalWidth; canvas.height = img.naturalHeight;
                    resetAll();
                };
            };
            reader.readAsDataURL(file);
        };

        function setGrid(percentX, percentY, btnIdx) {
            gridOffsetX = percentX; 
            gridOffsetY = percentY;
            document.querySelectorAll('.grid-btn').forEach((b, i) => b.classList.toggle('active', i === btnIdx));
            panX = 0; panY = 0; // Reset manual pan when clicking a block
            if (zoomRange.value < 2) zoomRange.value = 2.0; 
            updateView();
        }

        function updateView() {
            if (!img.src) return;
            const zoom = parseFloat(zoomRange.value);
            
            // Apply scale, grid offset, and manual panning
            // Percent offsets are adjusted slightly (45% instead of 50%) to create the 1cm overlap
            wrapper.style.transform = `scale(${zoom}) translate(${gridOffsetX + (panX/10)}%, ${gridOffsetY + (panY/10)}%) rotate(${rotation}deg) scaleX(${flip})`;

            const gray = document.getElementById('colorToggle').checked ? 0 : 100;
            const inv = document.getElementById('invertToggle').checked ? 100 : 0;
            const con = document.getElementById('contrast').value;
            img.style.filter = `grayscale(${gray}%) invert(${inv}%) contrast(${con}%)`;
            canvas.style.filter = document.getElementById('invertToggle').checked ? "invert(100%)" : "none";
        }

        const handleTouch = (e) => {
            if (shield.style.display === 'block') return;
            const mode = document.getElementById('touchMode').value;
            const touch = e.touches[0];
            const rect = canvas.getBoundingClientRect();
            
            if (mode === 'draw') {
                const x = (touch.clientX - rect.left) * (canvas.width / rect.width);
                const y = (touch.clientY - rect.top) * (canvas.height / rect.height);
                if (e.type === 'touchstart') { ctx.beginPath(); ctx.moveTo(x, y); }
                else if (e.type === 'touchmove') { 
                    ctx.lineTo(x, y); ctx.strokeStyle = "#007AFF"; ctx.lineWidth = 5; ctx.lineCap = "round"; ctx.stroke(); 
                }
            } else {
                if (e.type === 'touchstart') { isDragging = true; startX = touch.clientX - panX; startY = touch.clientY - panY; }
                else if (e.type === 'touchmove' && isDragging) { panX = touch.clientX - startX; panY = touch.clientY - startY; updateView(); }
            }
        };

        canvas.addEventListener('touchstart', handleTouch);
        canvas.addEventListener('touchmove', (e) => { e.preventDefault(); handleTouch(e); }, { passive: false });
        window.addEventListener('touchend', () => isDragging = false);

        function saveProject() {
            if (!img.src) return;
            const transaction = db.transaction(["projects"], "readwrite");
            transaction.objectStore("projects").add({ image: img.src, drawing: canvas.toDataURL(), timestamp: Date.now() });
            transaction.oncomplete = loadGallery;
        }

        function loadGallery() {
            const list = document.getElementById('gallery-list'); list.innerHTML = "";
            db.transaction("projects").objectStore("projects").openCursor(null, "prev").onsuccess = (e) => {
                const cursor = e.target.result;
                if (cursor) {
                    const item = document.createElement('div');
                    item.className = "gallery-item"; item.style.backgroundImage = `url(${cursor.value.image})`;
                    item.onclick = () => {
                        img.src = cursor.value.image;
                        wrapper.style.display = 'block';
                        img.onload = () => {
                            canvas.width = img.naturalWidth; canvas.height = img.naturalHeight;
                            const overlay = new Image(); overlay.onload = () => ctx.drawImage(overlay, 0, 0); overlay.src = cursor.value.drawing;
                            updateView();
                        };
                    };
                    list.appendChild(item); cursor.continue();
                }
            };
        }

        function clearDraw() { ctx.clearRect(0, 0, canvas.width, canvas.height); }
        function rotateImg() { rotation = (rotation + 90) % 360; updateView(); }
        function resetAll() { panX = 0; panY = 0; gridOffsetX = 0; gridOffsetY = 0; rotation = 0; zoomRange.value = 1.0; updateView(); }
        function toggleMenu(v) { ui.style.display = v ? 'block' : 'none'; showBtn.style.display = v ? 'none' : 'block'; }

        async function lockApp() {
            toggleMenu(false); shield.style.display = 'block'; unlockBtn.style.display = 'flex';
            if ('wakeLock' in navigator) wakeLock = await navigator.wakeLock.request('screen');
            if (document.documentElement.requestFullscreen) document.documentElement.requestFullscreen();
        }

        function unlockApp() {
            toggleMenu(true); shield.style.display = 'none'; unlockBtn.style.display = 'none';
            if (wakeLock) { wakeLock.release(); wakeLock = null; }
            if (document.exitFullscreen) document.exitFullscreen();
        }
    </script>
</body>
</html>
